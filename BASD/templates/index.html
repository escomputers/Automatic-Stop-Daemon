{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>BASD</title>

    <!-- favicon -->
    <link rel="shortcut icon" href="{% static "images/icon.ico" %}"/>

    <!-- jquery -->
    <script src="{% static "plugins/jquery/jquery.min.js" %}"></script>

    <!-- jquery validation -->
    <script src="{% static "plugins/jquery-validation/jquery.validate.min.js" %}"></script>
    <script src="{% static "plugins/jquery-validation/additional-methods.min.js" %}"></script>

    <!-- moment -->
    <script src="{% static "plugins/moment/moment-with-locales.min.js" %}"></script>

    <!-- bootstrap -->
    <link rel="stylesheet" href="{% static "plugins/bootstrap/css/bootstrap.min.css" %}" >
    <script src="{% static "plugins/bootstrap/js/bootstrap.bundle.min.js" %}"></script>

    <!-- bootstrap datetimepicker -->
    <link rel="stylesheet" type="text/css" href="{% static "plugins/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css" %}">
	  <script src="{% static "plugins/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js" %}"></script>

    <!-- Font Awesome -->
	  <script src="https://kit.fontawesome.com/cde9b9d9b2.js" crossorigin="anonymous"></script>

    <!-- timezones -->
    <script src="{% static 'plugins/easy-tz-picker/timezones.full.js' %}"></script>

    <!-- github buttons -->
    <script src="{% static 'plugins/github/buttons.min.js' %}"></script>

    <!-- initialize tooltip and easy timezone picker plugins -->
    <script>
    $(function () {
      // bootstrap tooltip
      $('[data-toggle="tooltip"]').tooltip();

      // easy timezone picker
      $("#tz").timezones();

      // bootstrap datetimepicker
      $("#start_time").datetimepicker({
		    format: "HH:mm",
		    stepping: 1,
      });

    })
    </script>

  </head>
  <body>

<div class="container-fluid">
  <h3 class="display-4">Binance Automatic Stop Daemon</h3>
</div>
    
  <div class="container-fluid">

  <form id="Form" action="">

      <div class="card card-outline card-primary">
          <div class="card-body">

            <div class="row"><!-- first row -->
                <div class="col-sm">
                    <div class="form-group">
                      <label for="api_key"><i class='fa fa-key'></i> API Key</label> 
                      <input type="text" class="form-control pull-right" name="api_key" data-toggle="tooltip" title="your Binance.com API Key" placeholder="your Binance.com API Key">
                    </div>
                  </div>
                  <div class="col-sm">
                    <div class="form-group">
                      <label for="api_secret"><i class='fa fa-key'></i> API Secret Key</label> 
                      <input type="text" class="form-control pull-right" name="api_secret" data-toggle="tooltip" title="your Binance.com API Secret Key" placeholder="your Binance.com API Secret Key">
                    </div>
                  </div>
                  <div class="col-sm">
                    <div class="form-group">
                      <label for="tz"><i class='fa fa-map-location'></i> Timezone</label> 
                      <select id="tz" class="form-control" style="width: 100%;">
                      </select> 
                    </div>
                  </div>
                  <div class="col-sm">
                  <div class="form-group">
                    <label for="start_time"><i class='fa fa-clock'></i> Start time</label> 
                    <input type="text" class="form-control pull-right" id="start_time" name="start_time" title="Select Start time" placeholder="Select Start time">
                  </div>
                </div>
                <div class="col-sm">
                  <div class="form-group">
                    <label for="active_hours"><i class='fa fa-clock'></i> Active hours</label> 
                    <input type="text" class="form-control pull-right" name="active_hours" data-toggle="tooltip" title="Insert how many working hours. 24 equals to all day" placeholder="Enter Active hours">
                  </div>
                </div>
            </div><!-- end first row -->

            <div class="row"><!-- second row -->
              <div class="col-sm-2">
                <div class="form-group">
                  <label for="tz"><i class='fa fa-sort'></i> Order type</label> 
                  <select id="order_type" name="order_type" class="form-control" style="width: 100%;" placeholder="Select order type">
                    <option value="tp">Take Profit</option>
                    <option value="sl">Stop Loss</option>
                    <option value="oco">OCO</option>
                  </select> 
                </div>
              </div>

              <div id="TP">
                <div class="col-sm">
                  <input type="text" class="form-control pull-right" name="tp_s" data-toggle="tooltip" title="Take Profit Stop percentage" placeholder="Take Profit Stop +%">
                  <input type="text" class="form-control pull-right" name="tp_l" data-toggle="tooltip" title="Take Profit Limit percentage" placeholder="Take Profit Limit +%">
                </div>
              </div>

              <div id="OCO">
                <div class="col-sm">
                  <input type="text" class="form-control pull-right" name="oco_tp" data-toggle="tooltip" title="OCO Take Profit percentage" placeholder="OCO Take Profit +%">
                  <input type="text" class="form-control pull-right" name="oco_sl_s" data-toggle="tooltip" title="OCO Stop Loss Stop percentage, must be LOWER than market price WHEN order will be placed" placeholder="OCO Stop Loss Stop -%">
                  <input type="text" class="form-control pull-right" name="oco_sl_l" data-toggle="tooltip" title="OCO Stol Loss Limit percentage, must be HIGHER than market price WHEN order will be placed" placeholder="OCO Stop Loss Limit -%">
                </div>
              </div>

              <div id="SL">
                <div class="col-sm">
                  <input type="text" class="form-control pull-right" name="sl_s" data-toggle="tooltip" title="Stop Loss Stop percentage" placeholder="Stop Loss Stop -%">
                  <input type="text" class="form-control pull-right" name="sl_l" data-toggle="tooltip" title="Stop Loss Limit percentage" placeholder="Stop Loss Limit -%">
                </div>
              </div>

              <div class="btn-group-toggle" data-toggle="buttons">
                <label class="btn btn-light active">
                  <input type="checkbox" id="email_alert"><i class='fa fa-envelope'></i> Email alert
                </label>
              </div>

              <div id="email_fields">
                <div class="col-sm">
                  <div class="form-group">
                    <input type="email" class="form-control pull-right" id="sender_email" name="sender_email" data-toggle="tooltip" title="sender email address (Gmail only)" placeholder="Gmail sender address">
                    <input type="password" class="form-control pull-right" id="password" name="password" data-toggle="tooltip" title="Gmail app password" placeholder="Gmail app password">
                    <input type="email" class="form-control pull-right" id="receiver_email" name="receiver_email" data-toggle="tooltip" title="receiver email address" placeholder="Receiver email address">
                  </div>
                </div>
              </div>

              <div class="col-sm">
                <a class="github-button" href="https://github.com/escomputers/BASD" data-icon="octicon-star" data-size="large" data-show-count="true" aria-label="Star escomputers/BASD on GitHub">Star</a>
                <a class="github-button" href="https://github.com/escomputers/BASD/fork" data-icon="octicon-repo-forked" data-size="large" data-show-count="true" aria-label="Fork escomputers/BASD on GitHub">Fork</a>
                <a class="github-button" href="https://github.com/escomputers/BASD/issues" data-icon="octicon-issue-opened" data-size="large" data-show-count="true" aria-label="Issue escomputers/BASD on GitHub">Issue</a>
                <a class="github-button" href="https://github.com/escomputers/BASD/discussions" data-icon="octicon-comment-discussion" data-size="large" aria-label="Discuss escomputers/BASD on GitHub">Discuss</a>
              </div>
            </div><!-- end second row -->

            <div class="col-sm">
              <div class="form-group">
                </div>
            </div><!-- empty row -->

            <div class="row">
              <input class="submit btn btn-primary btn-block" type="submit" value="Validate">
            </div>

          </div><!-- end card-body -->
      </div><!-- end ard card-outline card-primary  -->
  </form>
</div>
</body>
<script>
	$().ready(function() {

    // hide email and order fields on page load
    $("#email_fields, #OCO, #SL").hide();

    // add method for checking spaces
    jQuery.validator.addMethod("noSpace", function(value, element) { 
      return value.indexOf(" ") < 0 && value != ""; 
      }, "No spaces"
    );

    // rule grouping for order percentages
    let ruleSetPercentage = {
        required: true,
        number: true,
        range: [0.5, 200]
    };

		// validate signup form on keyup and submit
		$("#Form").validate({
      validClass: "font-weight-bold alert-success",
      errorClass: "font-weight-bold alert-danger",
      ignore: "#sender_email, #receiver_email",
			rules: {
				api_key: {
					required: true,
					minlength: 64,
          noSpace: true
				},
        api_secret: {
					required: true,
					minlength: 64,
          noSpace: true
				},
        tz: {
          required: true
        },
        start_time: {
          required: true
        },
        active_hours: {
          required: true,
          number: true,
          range: [1, 24]
        },
        order_type: {
          required: true
        },
        tp_s: ruleSetPercentage,
        tp_l: ruleSetPercentage,
        oco_tp: ruleSetPercentage,
        oco_sl_s: ruleSetPercentage,
        oco_sl_l: ruleSetPercentage,
        sl_s: ruleSetPercentage,
        sl_l: ruleSetPercentage,
				password: {
					required: true,
					minlength: 8,
          noSpace: true
				},
			},
		  messages: {
        api_key: {
          minlength: "Your API Key must consist of at least 64 characters"
        },
        api_secret: {
          minlength: "Your API Secret Key must consist of at least 64 characters"
        },
				password: {
					minlength: "Your password must be at least 8 characters long"
				}
      },

      // change css class to error
      highlight: function (element, errorClass, validClass) {
        $(element).addClass(errorClass).removeClass("font-weight-bold alert-success");
      },

      // change css class to success
      unhighlight: function (element, errorClass, validClass) {
        $(element).removeClass(errorClass).addClass("font-weight-bold alert-success");
      }
		});

    // show email fields basing on checkbox
    $("#email_alert").change(function() {
      checkbox_status = $("#email_alert").prop("checked")
      if (checkbox_status === true) {
        $("#email_fields").show();
        $("#sender_email, #password, #receiver_email").prop("required", true).addClass("form-control pull-right alert-danger");
      } else {
        $("#email_fields").hide();
      }
    });

  // validate sender Gmail address
  $("#sender_email").keyup(function() {
    let input = this.value;
    let stringCheck = "@gmail.com";
    let validation = (input.lastIndexOf(stringCheck) === input.length - stringCheck.length) > 0;
    if (validation === false) {
      $("#sender_email-error").remove();
      $("#sender_email").removeClass();
      $("#sender_email").addClass("form-control pull-right font-weight-bold alert-danger");
      $("#sender_email").after("<label id='sender_email-error' class='alert-danger font-weight-bold' for='sender_email'>Not a valid Gmail address</label>")
    } else {
      $("#sender_email").removeClass();
      $("#sender_email-error").remove();
      $("#sender_email").addClass("form-control pull-right font-weight-bold alert-success");
    }
  });

  // validate receiver email address
  function emailValidate(input) {
    let filter = /^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;
    if (filter.test(input)) {
      return true;
    } else {
      return false;
    }
  }

  // get user input for receiver email address e check it
  $("#receiver_email").keyup(function() {
    let input = this.value;
    emailValidate(input)
    if (emailValidate(input) === false) {
      $("#receiver_email-error").remove();
      $("#receiver_email").removeClass();
      $("#receiver_email").addClass("form-control pull-right font-weight-bold alert-danger");
      $("#receiver_email").after("<label id='receiver_email-error' class='alert-danger font-weight-bold' for='receiver_email'>Not a valid email address</label>")
    } else {
      $("#receiver_email").removeClass();
      $("#receiver_email-error").remove();
      $("#receiver_email").addClass("form-control pull-right font-weight-bold alert-success");
    }
  });

  // show order fields basing on selected value
  $("#order_type").change(function() {
	  selected_value = $("#order_type").val()
    if (selected_value === 'sl') {
	    $("#OCO, #TP").hide();
      $("#SL").show();
    } else if (selected_value === 'oco') {
      $("#SL, #TP").hide();
      $("#OCO").show();
	  } else {
      $("#SL, #OCO").hide();
      $("#TP").show();
    }
  });

}); // end $().ready(function()
</script>
</html>