{% load static %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>BASD - job details</title>
        <!-- favicon -->
        <link rel="shortcut icon" href="{% static 'images/icon.ico' %}"/>

        <!-- jquery -->
        <script src="{% static 'plugins/jquery/jquery.min.js' %}"></script>
    
        <!-- bootstrap -->
        <link rel="stylesheet" href="{% static 'plugins/bootstrap/css/bootstrap.min.css' %}" >
        <script src="{% static 'plugins/bootstrap/js/bootstrap.bundle.min.js' %}"></script>

        <!-- moment -->
        <script src="{% static 'plugins/moment/moment-with-locales.min.js' %}"></script>
        <script src="{% static 'plugins/moment/moment-timezone-with-data-10-year-range.min.js' %}"></script>
    
        <!-- Font Awesome -->
        <script src="https://kit.fontawesome.com/cde9b9d9b2.js" crossorigin="anonymous"></script>
    
        <!-- github buttons -->
        <script src="{% static 'plugins/github/buttons.min.js' %}"></script>

  </head>
  <body>

  <div class="container-fluid">
    <h3 class="display-4">
      Binance Automatic Stop Daemon
      <small class="text-muted">- job details</small>
    </h3>
  </div>

  <div class="container-fluid">

    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th scope="col"><i class="fa fa-circle"></i> Status</th>
            <th scope="col"><i class="fa fa-id-card"></i> ID</th>
            <th scope="col"><i class="fa fa-envelope"></i> Alert</th>
            <th scope="col"><i class="fa fa-map-location"></i> Timezone</th>
            <th scope="col"><i class='fa fa-clock'></i> Start time</th>
            <th scope="col"><i class='fa fa-clock'></i> End time</th>
            <th scope="col"><i class='fa fa-money-bill-1-wave'></i> Order type</th>
            <th scope="col"><i class='fa fa-percent'></i> Stop</th>
            <th scope="col"><i class='fa fa-percent'></i> Limit</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td id="status"></td>
            <td><button type="button" id="id" class="btn btn-outline-primary"></button></td>
            <td id="alert"></td>
            <td><button type="button" id="tz" class="btn btn-outline-primary"></button></td>
            <td><button type="button" id="start_time" class="btn btn-outline-primary"></button></td>
            <td><button type="button" id="end_time" class="btn btn-outline-primary"></button></td>
            <td id="order_type"></td>
            <td id="pct1">4.12</td>
            <td id="pct2">4.03</td>
          </tr>
        </tbody>
      </table>
    </div>

      <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <strong>Warning:</strong> If you close this page, job will be canceled!
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

            <div class="col-sm">
              <div class="form-group">
                </div>
            </div><!-- empty row -->

            <div class="d-flex justify-content-center">
              <a class="github-button" href="https://github.com/escomputers/BASD" data-icon="octicon-star" data-size="large" data-show-count="true" aria-label="Star escomputers/BASD on GitHub">Star</a>
              <a class="github-button" href="https://github.com/escomputers/BASD/fork" data-icon="octicon-repo-forked" data-size="large" data-show-count="true" aria-label="Fork escomputers/BASD on GitHub">Fork</a>
              <a class="github-button" href="https://github.com/escomputers/BASD/issues" data-icon="octicon-issue-opened" data-size="large" data-show-count="true" aria-label="Issue escomputers/BASD on GitHub">Issue</a>
              <a class="github-button" href="https://github.com/escomputers/BASD/discussions" data-icon="octicon-comment-discussion" data-size="large" aria-label="Discuss escomputers/BASD on GitHub">Discuss</a>
            </div>

          </div><!-- end card-body -->
      </div><!-- end ard card-outline card-primary  -->
</div>
<script>
  // get job error if present
  let errorId = {};

  function callError() {
  $.ajax({
    url: "{% url 'errors' %}",
      success: function(data) {
        try {
          errorId = data[0].error
          getError(errorId)
        } 
        catch(err) {}
    }
  })
  function getError(errorId) { // 
    if (errorId === jsondata.id) { 
      $("#status").replaceWith("<td id='status'><button type='button' class='btn btn-danger'>Error</button></td>");
    } else {
      $("#status").replaceWith("<td id='status'><button type='button' class='btn btn-success'>Ready</button></td>");
    }
  }
}

  // get variables from previous page stored in Session
  const data = sessionStorage.getItem("data");
  const jsondata = JSON.parse(data);

  console.log(jsondata)

  // fill table with values
  callError()
  document.getElementById("tz").innerHTML = jsondata.tz; // timezone
  document.getElementById("start_time").innerHTML = jsondata.start_time; // start time
  document.getElementById("id").innerHTML = jsondata.id; // id

  if (jsondata.receiver_email) {
    document.getElementById("alert").innerHTML = jsondata.receiver_email;
  } else {
    $("#alert").replaceWith("<td id='alert'><button type='button' class='btn btn-danger'>Not set</button></td>");
  }

  // calc end time from starting time and active hours
  const startTime = moment(jsondata.start_time,"H:mm");
  const currentDate = moment.tz(jsondata.tz);
  const startDateTime = currentDate.set({hour:startTime.hour(),minute:startTime.minutes()})//.format("DD-MM-YYYY H:mm")
  const endTime = startDateTime.add(jsondata.active_hours, "hours").format("H:mm")
  document.getElementById("end_time").innerHTML = endTime;

  // order type
  let orderType = '';
  if (jsondata.order_type === 'tp') {
    $("#order_type").replaceWith("<td id='order_type'><button type='button' class='btn btn-success'>Take Profit</button></td>");
  }
  if (jsondata.order_type === 'sl') {
    $("#order_type").replaceWith("<td id='order_type'><button type='button' class='btn btn-danger'>Stop Loss</button></td>");
  }
  if (jsondata.order_type === 'oco') {
    $("#order_type").replaceWith("<td id='order_type'><button type='button' class='btn btn-warning'>OCO</button></td>");
  }

</script>
</body>
</html>